<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Risk Measurement</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        .slider-thumb::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { jsPDF } = window.jspdf;

        // --- Helper Functions ---

        function samplePERT(min, mode, max, lambda = 4) {
            if (min === max) return min;
            const mean = (min + lambda * mode + max) / (lambda + 2);
            const u = Math.random();
            const c = (mode - min) / (max - min);
            
            if (u < c) {
                return min + Math.sqrt(u * (max - min) * (mode - min));
            } else {
                return max - Math.sqrt((1 - u) * (max - min) * (max - mode));
            }
        }

        function samplePoisson(lambda) {
            const L = Math.exp(-lambda);
            let k = 0;
            let p = 1;
            do {
                k++;
                p *= Math.random();
            } while (p > L);
            return k - 1;
        }

        const cleanID = (id) => String(id || '').trim().toLowerCase();

        const normalizeData = (jsonData) => {
            if (!jsonData || jsonData.length === 0) return [];
            return jsonData.map(row => {
                const newRow = {};
                const findVal = (keywords) => {
                    const foundKey = Object.keys(row).find(k => {
                        const cleanK = k.toLowerCase().replace(/[^a-z0-9]/g, '');
                        return keywords.every(kw => cleanK.includes(kw));
                    });
                    return foundKey ? row[foundKey] : undefined;
                };
                Object.keys(row).forEach(key => {
                    const cleanKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
                    newRow[cleanKey] = row[key];
                });
                newRow['scenarioid'] = findVal(['scenario', 'id']);
                newRow['controlid'] = findVal(['control', 'id']);
                newRow['threatid'] = findVal(['threat', 'id']);
                newRow['assetid'] = findVal(['asset', 'id']);
                newRow['map_reduction'] = findVal(['control', 'reduction', 'likely']); 
                newRow['gen_reduction'] = findVal(['reduction', 'likely']); 
                newRow['tefmin'] = findVal(['base', 'tef', 'min']);
                newRow['tefml'] = findVal(['base', 'tef', 'likely']); 
                newRow['tefmax'] = findVal(['base', 'tef', 'max']);
                newRow['lossbase'] = findVal(['base', 'loss']);
                return newRow;
            });
        };

        function App() {
            const [companyName, setCompanyName] = useState('');
            const [assessorName, setAssessorName] = useState('');
            const [email, setEmail] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [logo, setLogo] = useState(null);
            const [data, setData] = useState({ assets: [], threats: [], scenarios: [], controls: [], map: [] });
            const [isLoaded, setIsLoaded] = useState(false);
            const [selectedScenarios, setSelectedScenarios] = useState(new Set());
            const [selectedControls, setSelectedControls] = useState(new Set());
            const [trials, setTrials] = useState(1000); 
            const [simResults, setSimResults] = useState(null);
            const [isSimulating, setIsSimulating] = useState(false);
            const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);
            const histRef = useRef(null);
            const lecRef = useRef(null);

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const getSheet = (name) => {
                            const ws = wb.Sheets[name];
                            if (!ws) return [];
                            const json = XLSX.utils.sheet_to_json(ws);
                            return normalizeData(json);
                        };
                        const newData = {
                            assets: getSheet('Assets'),
                            threats: getSheet('Threats'),
                            scenarios: getSheet('Scenarios'),
                            controls: getSheet('Controls'),
                            map: getSheet('Threat_Control_Map')
                        };
                        setData(newData);
                        setIsLoaded(true);
                    } catch (error) {
                        console.error("Error parsing file:", error);
                        alert("Error parsing Excel file. Please ensure it matches the template.");
                    }
                };
                reader.readAsBinaryString(file);
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setLogo(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const calculatedMetrics = useMemo(() => {
                if (data.scenarios.length === 0) return null;
                let aggTefMin = 0; let aggTefMl = 0; let aggTefMax = 0;
                let weightedLossSumMin = 0; let weightedLossSumMl = 0; let weightedLossSumMax = 0;
                let totalTefMl = 0;
                
                // Aggregated Expected Annual Loss (EAL) counters
                let aggEalMin = 0;
                let aggEalMl = 0;
                let aggEalMax = 0;

                selectedScenarios.forEach(rawScenId => {
                    const scenId = cleanID(rawScenId);
                    const scenario = data.scenarios.find(s => cleanID(s['scenarioid']) === scenId);
                    if (!scenario) return;
                    const threatId = cleanID(scenario['threatid']);
                    const assetId = cleanID(scenario['assetid']);
                    const threat = data.threats.find(t => cleanID(t['threatid']) === threatId);
                    const asset = data.assets.find(a => cleanID(a['assetid']) === assetId);
                    if (!threat || !asset) return;

                    let reductionProduct = 1.0;
                    const relevantMappings = data.map.filter(m => cleanID(m['threatid']) === threatId);
                    
                    relevantMappings.forEach(mapping => {
                        const controlId = cleanID(mapping['controlid']);
                        if (selectedControls.has(controlId)) {
                            let reductionPercent = 0;
                            if (mapping['map_reduction'] !== undefined) {
                                reductionPercent = parseFloat(mapping['map_reduction']);
                            } else if (mapping['gen_reduction'] !== undefined) {
                                reductionPercent = parseFloat(mapping['gen_reduction']);
                            } else {
                                const control = data.controls.find(c => cleanID(c['controlid']) === controlId);
                                if (control && control['gen_reduction'] !== undefined) {
                                    reductionPercent = parseFloat(control['gen_reduction']);
                                }
                            }
                            if (!isNaN(reductionPercent)) {
                                reductionProduct *= (1 - (reductionPercent / 100));
                            }
                        }
                    });

                    const baseMin = parseFloat(threat['tefmin']) || 0;
                    const baseMl = parseFloat(threat['tefml']) || 0;
                    const baseMax = parseFloat(threat['tefmax']) || 0;
                    const adjTefMin = baseMin * reductionProduct; 
                    const adjTefMl = baseMl * reductionProduct;
                    const adjTefMax = baseMax * reductionProduct;
                    aggTefMin += adjTefMin; aggTefMl += adjTefMl; aggTefMax += adjTefMax;

                    let lossBase = parseFloat(asset['lossbase']) || 0;
                    let lossMin = lossBase * 0.5; let lossMl = lossBase; let lossMax = lossBase * 2.0;
                    
                    weightedLossSumMin += (adjTefMl * lossMin);
                    weightedLossSumMl += (adjTefMl * lossMl);
                    weightedLossSumMax += (adjTefMl * lossMax);
                    totalTefMl += adjTefMl;
                    
                    // New EAL Formula: Adjusted TEF * Loss Per Event
                    aggEalMin += (adjTefMin * lossMin);
                    aggEalMl += (adjTefMl * lossMl);
                    aggEalMax += (adjTefMax * lossMax);
                });

                // Weighted averages for "Average Loss Per Event"
                const avgLossMin = totalTefMl > 0 ? weightedLossSumMin / totalTefMl : 0;
                const avgLossMl = totalTefMl > 0 ? weightedLossSumMl / totalTefMl : 0;
                const avgLossMax = totalTefMl > 0 ? weightedLossSumMax / totalTefMl : 0;

                return {
                    scenarioCount: selectedScenarios.size,
                    controlCount: selectedControls.size,
                    tef: { min: aggTefMin, ml: aggTefMl, max: aggTefMax },
                    loss: { min: avgLossMin, ml: avgLossMl, max: avgLossMax },
                    eal: { min: aggEalMin, ml: aggEalMl, max: aggEalMax },
                    weightSum: totalTefMl
                };
            }, [selectedScenarios, selectedControls, data]);

            const runSimulation = () => {
                if (!calculatedMetrics || calculatedMetrics.scenarioCount === 0) {
                    alert("Please enable at least one scenario.");
                    return;
                }
                setIsSimulating(true);
                setTimeout(() => {
                    const results = [];
                    const { tef, loss } = calculatedMetrics;
                    for (let i = 0; i < trials; i++) {
                        const sampledTef = samplePERT(tef.min, tef.ml, tef.max, 4);
                        const eventCount = samplePoisson(sampledTef);
                        let annualLoss = 0;
                        for (let k = 0; k < eventCount; k++) {
                            annualLoss += samplePERT(loss.min, loss.ml, loss.max, 4);
                        }
                        results.push(annualLoss);
                    }
                    results.sort((a, b) => a - b);
                    const mean = results.reduce((a, b) => a + b, 0) / results.length;
                    const p90 = results[Math.floor(results.length * 0.90)];
                    const p95 = results[Math.floor(results.length * 0.95)];
                    const probEvent = results.filter(r => r > 0).length / results.length;
                    setSimResults({ data: results, metrics: { mean, p90, p95, probEvent } });
                    setIsSimulating(false);
                }, 100);
            };

            useEffect(() => {
                if (simResults) {
                    const { data: losses } = simResults;
                    const n = losses.length;
                    const xLec = [], yLec = [];
                    for (let i = 0; i < n; i++) { xLec.push(losses[i]); yLec.push(1 - (i / n)); }

                    const traceHist = { 
                        x: losses, 
                        type: 'histogram', 
                        marker: { color: '#0ea5e9', line: { color: 'white', width: 1 } }, // Teal-blue with white borders
                        opacity: 0.8,
                        name: 'Frequency' 
                    };
                    const traceLec = { x: xLec, y: yLec, mode: 'lines', type: 'scatter', line: { color: '#ef4444', width: 2 } };
                    
                    const layoutCommon = { font: { family: 'Inter' }, margin: { t: 30, l: 40, r: 20, b: 30 }, height: 350 };
                    const layoutHist = { 
                        ...layoutCommon, 
                        title: 'Annual Loss Histogram', 
                        xaxis: {title: 'Loss (USD)'}, 
                        yaxis: {title: 'Frequency'},
                        bargap: 0.05 
                    };
                    const layoutLec = { ...layoutCommon, title: 'Loss Exceedance Curve', xaxis: {title: 'Loss (USD)', type: 'log'}, yaxis: {title: 'Prob'} };

                    if (histRef.current) Plotly.newPlot(histRef.current, [traceHist], layoutHist);
                    if (lecRef.current) Plotly.newPlot(lecRef.current, [traceLec], layoutLec);
                }
            }, [simResults]);

            const downloadPDF = async () => {
                try {
                    setIsGeneratingPDF(true);
                    
                    const doc = new jsPDF({ unit: 'in', format: 'letter' });
                    const margin = 0.5;
                    let y = 0.5;

                    doc.setFontSize(18);
                    doc.text("OT Risk Measurement Report", margin, y + 0.2); 
                    
                    if (logo) {
                        try {
                            const pageWidth = doc.internal.pageSize.getWidth();
                            const logoX = pageWidth - margin - 0.79; 
                            doc.addImage(logo, 'JPEG', logoX, y, 0.79, 0.79);
                        } catch (e) { console.warn("Could not add logo", e); }
                    }
                    y += 0.5;
                    
                    doc.setFontSize(12);
                    doc.text(`Company: ${companyName || 'N/A'}`, margin, y);
                    y += 0.25;
                    doc.text(`Date: ${date}`, margin, y);
                    y += 0.25;
                    doc.text(`Assessor: ${assessorName || 'N/A'}`, margin, y);
                    y += 0.25;
                    doc.text(`Email: ${email || 'N/A'}`, margin, y);
                    y += 0.5;

                    doc.setFontSize(14);
                    doc.text("Input Summary", margin, y);
                    y += 0.3;
                    
                    doc.setFontSize(10);
                    doc.text(`Enabled Scenarios: ${calculatedMetrics?.scenarioCount}`, margin, y);
                    y += 0.2;
                    doc.text(`Enabled Controls: ${calculatedMetrics?.controlCount}`, margin, y);
                    y += 0.2;
                    doc.text(`Simulation Trials: ${trials}`, margin, y);
                    y += 0.4;

                    doc.text("AGGREGATED TEF (Threat Event Frequency):", margin, y);
                    y += 0.2;
                    doc.text(`Min: ${calculatedMetrics?.tef.min.toFixed(3)}`, margin + 0.2, y);
                    doc.text(`ML: ${calculatedMetrics?.tef.ml.toFixed(3)}`, margin + 1.5, y);
                    doc.text(`Max: ${calculatedMetrics?.tef.max.toFixed(3)}`, margin + 2.8, y);
                    y += 0.4;

                    doc.text("Average Loss Per Event:", margin, y);
                    y += 0.2;
                    doc.text(`Min: ${fmt(calculatedMetrics?.loss.min)}`, margin + 0.2, y);
                    doc.text(`ML: ${fmt(calculatedMetrics?.loss.ml)}`, margin + 2.0, y);
                    doc.text(`Max: ${fmt(calculatedMetrics?.loss.max)}`, margin + 4.0, y);
                    y += 0.4;

                    doc.text("Expected Annual Loss Per Year:", margin, y);
                    y += 0.2;
                    doc.text(`Min: ${fmt(calculatedMetrics?.eal.min)}`, margin + 0.2, y);
                    doc.text(`ML: ${fmt(calculatedMetrics?.eal.ml)}`, margin + 2.0, y);
                    doc.text(`Max: ${fmt(calculatedMetrics?.eal.max)}`, margin + 4.0, y);
                    y += 0.5;

                    if (simResults) {
                        doc.setFontSize(14);
                        doc.text("Simulation Results", margin, y);
                        y += 0.3;

                        doc.setFontSize(10);
                        doc.text(`Expected Loss: ${fmt(simResults.metrics.mean)}`, margin, y);
                        y += 0.2;
                        doc.text(`P90 Loss: ${fmt(simResults.metrics.p90)}`, margin, y);
                        y += 0.2;
                        doc.text(`P95 Loss: ${fmt(simResults.metrics.p95)}`, margin, y);
                        y += 0.2;
                        doc.text(`Prob >= 1 Event: ${(simResults.metrics.probEvent * 100).toFixed(1)}%`, margin, y);
                        y += 0.4;

                        if (histRef.current) {
                            if (y > 7.5) { doc.addPage(); y = 0.5; }
                            const histImg = await Plotly.toImage(histRef.current, {format: 'png', width: 600, height: 350});
                            doc.addImage(histImg, 'PNG', margin, y, 6, 3.5);
                            y += 3.7;
                        }
                        
                        if (lecRef.current) {
                             if (y > 7.5) { doc.addPage(); y = 0.5; }
                            const lecImg = await Plotly.toImage(lecRef.current, {format: 'png', width: 600, height: 350});
                            doc.addImage(lecImg, 'PNG', margin, y, 6, 3.5);
                        }
                    }

                    doc.save(`OT_Risk_Report_${companyName || 'Assessment'}_${date}.pdf`);

                } catch (err) {
                    console.error('PDF generation failed:', err);
                    alert("Failed to generate PDF.");
                } finally {
                    setIsGeneratingPDF(false);
                }
            };

            const downloadSimCSV = () => {
                if (!simResults) return;
                const csv = ["Trial,Annual Loss"].concat(simResults.data.map((v, i) => `${i+1},${v}`)).join("\n");
                const link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
                link.download = `monte_carlo_results_${Date.now()}.csv`;
                link.click();
            };

            const downloadConfigCSV = () => {
                let rows = [["Type", "ID", "Name/Desc", "Selected"]];
                data.scenarios.forEach(s => {
                    const id = s['scenarioid'];
                    const desc = Object.values(s).find(v => typeof v === 'string' && v.length > 10 && v !== id) || "";
                    rows.push(["Scenario", id, `"${desc.replace(/"/g, '""')}"`, selectedScenarios.has(cleanID(id)) ? "Yes" : "No"]);
                });
                data.controls.forEach(c => {
                    const id = c['controlid'];
                    const name = Object.values(c).find(v => typeof v === 'string' && v.length > 5 && v !== id) || "";
                    rows.push(["Control", id, `"${name.replace(/"/g, '""')}"`, selectedControls.has(cleanID(id)) ? "Yes" : "No"]);
                });
                const link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n"));
                link.download = `configuration_${Date.now()}.csv`;
                link.click();
            };

            const toggleScen = (id) => {
                const cId = cleanID(id);
                const s = new Set(selectedScenarios);
                if (s.has(cId)) s.delete(cId); else s.add(cId);
                setSelectedScenarios(s);
            };
            const toggleCtrl = (id) => {
                const cId = cleanID(id);
                const s = new Set(selectedControls);
                if (s.has(cId)) s.delete(cId); else s.add(cId);
                setSelectedControls(s);
            };
            const toggleAllScen = (e) => setSelectedScenarios(e.target.checked ? new Set(data.scenarios.map(s => cleanID(s['scenarioid']))) : new Set());
            const toggleAllCtrl = (e) => setSelectedControls(e.target.checked ? new Set(data.controls.map(c => cleanID(c['controlid']))) : new Set());
            
            const fmt = (v) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits: 0}).format(v);
            const getDesc = (obj, idKey) => Object.values(obj).find(v => typeof v === 'string' && v.length > 5 && v !== obj[idKey]) || obj[idKey];

            return (
                <div className="min-h-screen pb-12 bg-gray-100">
                    <header className="bg-white border-b sticky top-0 z-50 px-8 h-16 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-4">
                            {logo ? <img src={logo} className="h-10" /> : <div className="h-10 w-10 bg-blue-100 rounded text-blue-600 flex items-center justify-center font-bold">OT</div>}
                            <h1 className="text-xl font-bold text-gray-900">OT Risk Measurement</h1>
                        </div>
                        <div className="text-sm text-gray-500">{companyName || 'Company'} | {date}</div>
                    </header>

                    <main className="max-w-7xl mx-auto px-8 py-8 space-y-8">
                        <div className="bg-white p-6 rounded-xl border shadow-sm">
                            <h2 className="text-lg font-semibold mb-4 pb-2 border-b">1. Assessment Details</h2>
                            <div className="flex flex-col md:flex-row gap-8">
                                <div className="flex-1 grid grid-cols-2 gap-6">
                                    <div><label className="block text-sm font-medium mb-1">Company</label><input className="w-full border p-2 rounded" value={companyName} onChange={e=>setCompanyName(e.target.value)} /></div>
                                    <div><label className="block text-sm font-medium mb-1">Date</label><input type="date" className="w-full border p-2 rounded" value={date} onChange={e=>setDate(e.target.value)} /></div>
                                    <div><label className="block text-sm font-medium mb-1">Assessor</label><input className="w-full border p-2 rounded" value={assessorName} onChange={e=>setAssessorName(e.target.value)} /></div>
                                    <div><label className="block text-sm font-medium mb-1">Email</label><input className="w-full border p-2 rounded" value={email} onChange={e=>setEmail(e.target.value)} /></div>
                                    <div className="col-span-2">
                                        <label className="block text-sm font-medium mb-2">Upload Assets, Threats, and Controls Excel profile</label>
                                        <label className={`flex items-center justify-center w-full px-4 py-3 rounded-lg cursor-pointer border transition ${isLoaded ? 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100' : 'bg-indigo-50 text-indigo-700 border-indigo-200 hover:bg-indigo-100'}`}>
                                            <i data-lucide="file-spreadsheet" className="w-5 h-5 mr-2"></i>
                                            <span className="text-sm font-semibold">{isLoaded ? `Loaded ${data.scenarios.length} Scenarios` : "Choose Excel Profile"}</span>
                                            <input type="file" onChange={handleFileUpload} className="hidden"/>
                                        </label>
                                    </div>
                                </div>
                                <div className="w-64 flex flex-col gap-4 border-l pl-8 items-center justify-center">
                                    <label className="block text-sm font-medium w-full text-center">Company Logo</label>
                                    <div className="w-full h-48 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 flex flex-col items-center justify-center relative">
                                        {logo ? <img src={logo} className="max-h-full max-w-full object-contain" alt="Logo" /> : <span className="text-gray-400 text-xs">Click to Upload</span>}
                                        <input type="file" onChange={handleLogoUpload} className="absolute inset-0 opacity-0 cursor-pointer"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {isLoaded && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2">
                                    <div className="bg-white rounded-xl border shadow-sm flex flex-col h-[600px]">
                                        <div className="p-3 bg-gray-50 border-b font-semibold flex justify-between">
                                            <span>Configuration</span>
                                            <span className="text-xs font-normal text-gray-500">Select items to assess</span>
                                        </div>
                                        <div className="flex-1 flex overflow-hidden">
                                            <div className="flex-1 border-r flex flex-col">
                                                <div className="p-2 bg-blue-50 border-b flex justify-between items-center"><span className="text-sm font-bold text-blue-800">Scenarios ({selectedScenarios.size})</span><label className="text-xs cursor-pointer"><input type="checkbox" onChange={toggleAllScen} /> All</label></div>
                                                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                                    {data.scenarios.map(s => (<label key={s.scenarioid} className="flex gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer border border-transparent hover:border-gray-200"><input type="checkbox" checked={selectedScenarios.has(cleanID(s.scenarioid))} onChange={()=>toggleScen(s.scenarioid)} /><div className="text-xs"><strong>{s.scenarioid}</strong><br/>{getDesc(s, 'scenarioid')}</div></label>))}
                                                </div>
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <div className="p-2 bg-green-50 border-b flex justify-between items-center"><span className="text-sm font-bold text-green-800">Controls ({selectedControls.size})</span><label className="text-xs cursor-pointer"><input type="checkbox" onChange={toggleAllCtrl} /> All</label></div>
                                                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                                    {data.controls.map(c => (<label key={c.controlid} className="flex gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer border border-transparent hover:border-gray-200"><input type="checkbox" checked={selectedControls.has(cleanID(c.controlid))} onChange={()=>toggleCtrl(c.controlid)} /><div className="text-xs"><strong>{c.controlid}</strong><br/>{getDesc(c, 'controlid')}</div></label>))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                                        <h3 className="font-semibold mb-4">Input Summary</h3>
                                        <div className="space-y-4 text-sm">
                                            <div className="flex justify-between border-b pb-2"><span>Enabled Scenarios</span><span className="font-bold">{calculatedMetrics?.scenarioCount || 0}</span></div>
                                            <div className="flex justify-between border-b pb-2"><span>Enabled Controls</span><span className="font-bold">{calculatedMetrics?.controlCount || 0}</span></div>
                                            <div className="bg-gray-50 p-2 rounded">
                                                <div className="text-xs font-bold text-gray-500 mb-1">AGGREGATED TEF (Threat Event Frequency)</div>
                                                <div className="grid grid-cols-3 gap-2 text-center">
                                                    <div><div className="text-xs text-gray-400">Min</div><div className="font-mono">{calculatedMetrics?.tef.min.toFixed(3)}</div></div>
                                                    <div><div className="text-xs text-gray-400">ML</div><div className="font-mono font-bold">{calculatedMetrics?.tef.ml.toFixed(3)}</div></div>
                                                    <div><div className="text-xs text-gray-400">Max</div><div className="font-mono">{calculatedMetrics?.tef.max.toFixed(3)}</div></div>
                                                </div>
                                            </div>
                                            
                                            <div className="border-t pt-2 space-y-1">
                                                <div className="text-xs font-bold text-gray-500 mb-1">Average Loss Per Event</div>
                                                <div className="flex justify-between"><span>Min</span><span className="font-mono">{fmt(calculatedMetrics?.loss.min||0)}</span></div>
                                                <div className="flex justify-between font-bold text-blue-600"><span>ML</span><span className="font-mono">{fmt(calculatedMetrics?.loss.ml||0)}</span></div>
                                                <div className="flex justify-between"><span>Max</span><span className="font-mono">{fmt(calculatedMetrics?.loss.max||0)}</span></div>
                                            </div>

                                            <div className="border-t pt-2 space-y-1">
                                                <div className="text-xs font-bold text-gray-500 mb-1">Expected Annual Loss Per Year</div>
                                                <div className="flex justify-between"><span>Min</span><span className="font-mono">{fmt(calculatedMetrics?.eal.min||0)}</span></div>
                                                <div className="flex justify-between font-bold text-green-600"><span>ML</span><span className="font-mono">{fmt(calculatedMetrics?.eal.ml||0)}</span></div>
                                                <div className="flex justify-between"><span>Max</span><span className="font-mono">{fmt(calculatedMetrics?.eal.max||0)}</span></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                                        <h3 className="font-semibold mb-4">Simulation</h3>
                                        <div className="space-y-4">
                                            <div><label className="block text-sm mb-1">Trials: {trials}</label><input type="range" min="100" max="1000" step="100" className="w-full" value={trials} onChange={e=>setTrials(Number(e.target.value))} /></div>
                                            <button onClick={runSimulation} disabled={isSimulating} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 disabled:opacity-50">{isSimulating ? 'Running...' : 'Run Simulation'}</button>
                                        </div>
                                    </div>

                                    {simResults && (
                                        <div className="flex gap-2">
                                            <button onClick={downloadConfigCSV} className="flex-1 bg-blue-500 text-white py-2 px-1 rounded text-xs hover:bg-blue-600 flex items-center justify-center gap-1"><i data-lucide="list-checks" className="w-3 h-3"></i> Config CSV</button>
                                            <button onClick={downloadSimCSV} className="flex-1 bg-green-600 text-white py-2 px-1 rounded text-xs hover:bg-green-700 flex items-center justify-center gap-1"><i data-lucide="file-spreadsheet" className="w-3 h-3"></i> Sim CSV</button>
                                            <button onClick={downloadPDF} disabled={isGeneratingPDF} className="flex-1 bg-gray-800 text-white py-2 px-1 rounded text-xs hover:bg-gray-900 flex items-center justify-center gap-1">{isGeneratingPDF ? '...' : <><i data-lucide="printer" className="w-3 h-3"></i> Report</>}</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {simResults && (
                            <div className="bg-white p-8 rounded-xl border shadow-sm space-y-8">
                                <h2 className="text-xl font-bold border-b pb-4">4. Simulation Results</h2>
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="p-4 bg-gray-50 rounded border"><div className="text-xs text-gray-500 uppercase">Expected Loss</div><div className="text-xl font-bold">{fmt(simResults.metrics.mean)}</div></div>
                                    <div className="p-4 bg-gray-50 rounded border"><div className="text-xs text-gray-500 uppercase">P90 Loss</div><div className="text-xl font-bold text-orange-600">{fmt(simResults.metrics.p90)}</div></div>
                                    <div className="p-4 bg-gray-50 rounded border"><div className="text-xs text-gray-500 uppercase">P95 Loss</div><div className="text-xl font-bold text-red-600">{fmt(simResults.metrics.p95)}</div></div>
                                    <div className="p-4 bg-gray-50 rounded border"><div className="text-xs text-gray-500 uppercase">Prob â‰¥1 Event</div><div className="text-xl font-bold text-blue-600">{(simResults.metrics.probEvent*100).toFixed(1)}%</div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="border rounded p-2"><div ref={histRef}></div></div>
                                    <div className="border rounded p-2"><div ref={lecRef}></div></div>
                                </div>
                            </div>
                        )}
                        <div className="text-center text-xs text-gray-400 pt-4">Developed by Steven Hsu</div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>